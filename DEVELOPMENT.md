# SharkByte Development Notes

## Architecture Overview

SharkByte is built on the Kiri:Moto foundation with the following key components:

### Core Structure
```
src/
â”œâ”€â”€ kiri/core/          # Core application logic
â”œâ”€â”€ kiri/mode/cam/      # CAM-specific functionality
â”œâ”€â”€ kiri/mode/fdm/      # 3D printing (inherited)
â”œâ”€â”€ kiri/mode/laser/    # Laser cutting (inherited)
â”œâ”€â”€ main/               # Application entry points
â”œâ”€â”€ geo/                # Geometry processing
â”œâ”€â”€ mesh/               # 3D mesh operations
â””â”€â”€ pack/               # Bundled/compiled output

web/
â”œâ”€â”€ kiri/               # Web interface
â”‚   â”œâ”€â”€ lang/          # Language files
â”‚   â””â”€â”€ index.html     # Main application
â””â”€â”€ lib/                # Generated JavaScript bundles
```

### Build System
- **ESBuild**: Modern JavaScript bundler for source compilation
- **Webpack**: Used for external library bundling (Three.js, JSZip)
- **Development**: `npm run dev` for live development server
- **Production**: `npm run prod` for optimized builds

## Key Modifications for SharkByte

### 1. Device Profiles
**File**: `src/kiri/dev/cam/CNC.Shark.HD4.json`
- Pre-configured for Shark HD4 specifications
- TAP file export with GRBL G-code
- Manual tool change workflow (M0 pauses)
- Inch-based units (G20) by default

### 2. Branding Updates
**Files**: Multiple across codebase
- HTML meta tags and titles
- Export file headers ("Generated by SharkByte")
- Application loading screens
- Package.json metadata

### 3. Removed Components
- **Bambu Module**: 3D printer integration not needed
- **Excess Device Profiles**: Focused on CNC workflow
- **Documentation**: Shark-specific guides only

## Development Workflow

### Initial Setup
```bash
git clone https://github.com/JarettHall/SharkByte.git
cd SharkByte
npm install
npm run setup        # Initialize all dependencies
```

### Development Server
```bash
npm run dev          # Starts on http://localhost:8080
```

### Building for Production
```bash
npm run prod         # Full production build
npm run webpack-src  # Rebuild source only
```

### Key Commands
```bash
npm run webpack-ext  # Bundle external libraries
npm run clean        # Clean build artifacts
npm run setup-mods   # Install module dependencies
```

## Important Development Notes

### 1. Language System
**Issue**: ES6 module compatibility
**Solution**: Created inline language definitions in `src/kiri/core/lang-en.js`
- Original uses `self.lang` (not ES6 compatible)
- SharkByte uses proper export/import syntax

### 2. Device Loading
**Location**: `src/pack/kiri-devs.js`
- Auto-generated from individual JSON files
- Rebuild required after device changes: `npm run webpack-src`

### 3. Favicon Generation
**Script**: `generate-favicons.js`
- Requires Sharp: `npm install sharp`
- Generates all icon variants from main logo
- Updates PWA manifest references

### 4. File Structure Dependencies
**Critical Files**:
- `src/data/index.js` - Required for mesh operations
- `src/kiri/core/lang-en.js` - Language definitions
- `web/kiri/lang/en.js` - Web-compatible language file

### 5. Build Troubleshooting

#### White Screen Issues
1. **Missing Dependencies**: Check `src/data/` exists
2. **Language Errors**: Verify `lang-en.js` has proper exports
3. **Module Loading**: Check browser console for import errors

#### Build Failures
1. **ESBuild Errors**: Usually path resolution issues
2. **Webpack Timeouts**: External library download problems
3. **Module Conflicts**: Check `package.json` versions

## Customization Guide

### Adding New Devices
1. Create JSON in `src/kiri/dev/cam/`
2. Follow existing naming convention
3. Rebuild: `npm run webpack-src`
4. Test device appears in dropdown

### Modifying Post-Processors
**Location**: Device JSON files
```json
{
  "file-ext": "tap",
  "pre": ["G20", "G90", "G17"],
  "post": ["M5", "M30"],
  "tool-change": ["M0"],
  "settings": { ... }
}
```

### UI Customization
**Files**:
- `web/kiri/index.html` - Main interface
- `web/kiri/index.css` - Styling
- `src/kiri/core/` - Application logic

### Adding Operations
**Location**: `src/kiri/mode/cam/op-*.js`
- Each operation type has dedicated file
- Follow existing patterns for new operations
- Update UI in corresponding init files

## Testing & Quality Assurance

### Manual Testing Checklist
- [ ] Application loads without errors
- [ ] Device selection shows "CNC Shark HD4"
- [ ] File import/export works
- [ ] Toolpath generation completes
- [ ] Export produces valid .tap files
- [ ] All major CAM operations function

### Performance Considerations
- **Large Models**: Reduce mesh complexity in CAD
- **Memory Usage**: Monitor browser memory with complex parts
- **Build Times**: Webpack can be slow on complex dependencies

### Browser Compatibility
- **Chrome/Edge**: Primary development target
- **Firefox**: Full compatibility
- **Safari**: Limited testing, should work
- **Mobile**: Not optimized, desktop recommended

## Common Development Issues

### 1. Port Already in Use
```bash
fuser -k 8080/tcp    # Kill process on port 8080
```

### 2. Module Not Found Errors
- Check relative paths in imports
- Verify file exists in expected location
- Rebuild after moving files

### 3. MIME Type Errors
- Usually indicates 404 on JavaScript files
- Check file paths and web server routing
- Verify build completed successfully

### 4. Language Loading Issues
- Ensure `lang-en.js` has proper ES6 exports
- Check browser network tab for failed requests
- Verify language file syntax

## Contributing Guidelines

### Code Style
- Follow existing patterns in codebase
- Use descriptive variable names
- Comment complex algorithms
- Maintain ES6 module compatibility

### Git Workflow
1. Fork repository
2. Create feature branch
3. Make focused commits
4. Test thoroughly
5. Submit pull request

### Documentation
- Update relevant .md files
- Add inline comments for complex code
- Update user guide for new features
- Test all documentation examples

## Resources

### Upstream Project
- **Kiri:Moto**: https://github.com/GridSpace/grid-apps
- **Documentation**: https://docs.grid.space/kiri-moto/
- **Community**: Various CAM/CNC forums

### CNC Shark Resources
- **Manufacturer**: Next Wave Automation
- **Community Forums**: Multiple user groups
- **G-code Reference**: GRBL documentation

### Development Tools
- **ESBuild**: https://esbuild.github.io/
- **Webpack**: https://webpack.js.org/
- **Three.js**: https://threejs.org/ (3D graphics)
- **Sharp**: https://sharp.pixelplumbing.com/ (image processing)

---

**Happy Coding!** ðŸ¦ˆðŸ’»